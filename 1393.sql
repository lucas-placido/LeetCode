SELECT DISTINCT 
  STOCK_NAME, 
  SUM(IF(OPERATION='Buy', -PRICE, PRICE))
    OVER(PARTITION BY STOCK_NAME) AS capital_gain_loss 
FROM STOCKS